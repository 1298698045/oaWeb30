<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="/css/themes/lightning/alerts.css" />
    <link rel="stylesheet" href="/css/themes/lightning/iconfont.css" />
    <link href="/element/element.css" rel="stylesheet" />
    <title></title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body, html {
            width: 100%;
        }

        .popup-exit {
            width: 20px;
            height: 20px;
            position: absolute;
            right: 15px;
            top: 15px;
            background: url('/img/cal/closegray.png') no-repeat center;
            background-size: 18px;
            cursor: pointer;
        }
        .popup-head {
            color: #333;
            height: 58px;
            line-height: 60px;
            font-size: 16px;
            text-align: center;
            border-bottom: 2px solid #dcdcdc;
        }

        #popup-zhuangtaichange .popup-body {
            padding: 20px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .popup-foot > div {
            width: 65px;
        }

        .popup-foot > div {
            float: right;
            background-color: white;
            border: 1px solid #dcdcdc;
            color: #108af9;
            height: 32px;
            border-radius: 4px;
            text-align: center;
            line-height: 32px;
            margin-right: 10px;
            cursor: pointer;
            margin-top: 10px;
            padding: 0 10px;
        }

        .popup-foot {
            border-radius: 0;
            border-top: 2px solid #dcdcdc;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            padding-bottom: 15px;
            height: 40px;
        }

            .popup-foot .popup-foot-shur {
                color: white;
                background-color: #108af9;
            }

        .red {
            color: red;
        }

        .item-left {
            float: left;
            width: 49%;
        }

        .item-right {
            float: right;
            width: 49%;
        }

        .popup-body {
            padding: 20px;
            height: 400px;
            overflow: auto;
        }

        .item-body {
            margin-top: 5px;
        }

        input {
            height: 32px;
            line-height: 32px;
            border-radius: 4px;
        }

        textarea {
            height: 50px;
        }

        input, textarea {
            width: 100%;
            border: 1px solid #dedede;
        }

        .item {
            margin-top: 10px;
        }

        .popup-foot .popup-foot-shur:hover {
            color: white;
            background-color: #0d7ade !important;
        }

        .disstatus {
            border-color: red;
        }

        .save-status {
            font-size: 12px;
            color: red;
        }

        .form-error {
            margin-top: 10px;
            text-align: left;
            width: 100%;
            background: rgb(194, 57, 52);
            padding: 15px;
            color: #fff;
            border-radius: 4px;
            height: 50px;
            box-sizing: border-box;
        }

        .form-error2 {
            color: rgb(194, 57, 52);
            margin-left: 15px;
            margin-top: 10px;
            font-size: 14px;
            text-align: left;
        }

        .item-title {
            display: inline-block;
            margin-bottom: 5px;
        }

        .section-title {
            padding: 5px;
            background-color: #f2f2f2;
            border-radius: 4px;
        }

        input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        .popup-body .layui-input-block {
            margin-left: 0;
        }

        .section-body {
            padding: 0 20px;
        }

        .section {
            padding-bottom: 20px;
        }

        .red {
            color: red;
        }

        .layui-form input {
            text-indent: 5px !important;
        }
        .upsort {
            border: 7px solid transparent;
            border-bottom: 7px solid rgb(27, 82, 151);
            margin: 5px 5px 10px 5px;
        }

        .downsort {
            border: 7px solid transparent;
            border-top: 7px solid rgb(27, 82, 151);
            margin: 10px 5px 5px 5px;
        }

        .torightdiv button {
            padding: 10px 5px 10px 15px;
        }

        .torightdiv button div {
            border: 7px solid transparent !important;
            border-left: 7px solid rgb(27, 82, 151) !important;
            height: 0;
        }

        .toleftdiv button {
            padding: 10px 10px 10px 5px;
        }

        .toleftdiv button div {
            border: 7px solid transparent !important;
            border-right: 7px solid rgb(27, 82, 151) !important;
            height: 0;
        }
        .popup table option {
            padding:8px 10px;
        }
        .checkselect input{
            width:16px;
            height:16px;
            line-height:16px;
        }

        #vueapp{
            margin-top:10px;
        }
        .el-input--suffix .el-input__inner{
            height: 30px;
            width: 240px;
        }
        .el-input__icon{
            line-height: 30px;
        }
        .shift-item{
            font-size:14px;
        }
        .item-left{
            margin-left:8px;
            float: left;
        }
        .shift-name-title{
            display:block;
        }
        .addrow{
            display:block;
            font-size:14px;
            margin-left:8px;
            margin-top:10px;
        }
        .el-icon-delete{
            cursor:pointer;
            float: right;
            margin-right:40px;
        }
        .shift-row{
            height:65px;
        }
        .addrow .el-button{
            padding:8px 10px;
        }
        .addrow .el-button:hover{
            color: rgba(27, 82, 151, 1.0);
            background-color: #ddd;
        }
        .el-radio__input.is-checked .el-radio__inner{
            border-color: rgba(27, 82, 151, 1.0);
            background: rgba(27, 82, 151, 1.0);
        }
        .el-radio__input.is-checked+.el-radio__label{
            color:rgba(27, 82, 151, 1.0);
        }
        .el-input--suffix .el-input__inner{
            padding-left: 6px;
        }
        
    </style>
</head>
<body>
    <div class="popup" style="display: block;">
        <div class="popup-exit close"></div>
        <div class="popup-head">
            选择要显示的字段
        </div>
        <div class="popup-body layui-form">
            <div class="modal-header"></div>
            <form id="editPage" name="editPage">
                <table cellpadding="0" cellspacing="8" style="width: 100%;">
                    <tr>
                        <td style="font-size: .8125rem; text-align: left;">可选字段</td>
                        <td>&nbsp;</td>
                        <td style="font-size: .8125rem; text-align: left;">可视字段</td>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <select class="due_select" id="duel_select_0" name="duel_select_0" style="width:300px; height: 220px;" multiple="multiple"></select>
                        </td>
                        <td width="50px">
                            <div class="torightdiv">
                                <button id="b1" type="button" class="s1 slds-button" style="background: none; border: 0;">
                                    <div></div>
                                </button>
                            </div>
                            <div class="toleftdiv">
                                <button type="button" id="b3" class="s1 slds-button" style="background: none; border: 0;">
                                    <div></div>

                                </button>
                            </div>
                        </td>
                        <td>
                            <select class="due_select" id="duel_select_1" name="duel_select_1" style="width:300px; height: 220px;" multiple="multiple"></select>
                        </td>
                        <td width="50px">
                            <p>
                                <button id="upsort" type="button" class="s1 slds-button" style="background: none; border: 0;" onclick="javascript:window.editPage_DLBEInstance.instMoveUp(document.editPage.duel_select_1, 'NAME', null, '排班对象无法删除，并且必须是被排班的人。','editPage_duel_errorMsg');">
                                    <div class="upsort"></div>
                                </button>
                            </p>
                            <!--<p>
                        <button type="button" id="b2" class="s1 slds-button">全部向右</button>
                    </p>-->
                            <p>
                                <button type="button" id="downsort" class="s1 slds-button" style="background: none; border: 0;" onclick="javascript:window.editPage_DLBEInstance.instMoveDown(document.editPage.duel_select_1, 'NAME', null, '排班对象无法删除，并且必须是被排班的人。','editPage_duel_errorMsg');">
                                    <div class="downsort"></div>
                                </button>
                            </p>
                            <!--  <p>
                          <button type="button" id="b4" class="s1 slds-button">全部向左</button>
                      </p>-->
                        </td>
                    </tr>
                </table>
            </form>
            <div id="vueapp">
                <div v-for="(sortrow,index) in sortdata" class="shift-row">
                    <div class="shift-item">
                        <div class="item-left">
                            <span class="shift-name-title">排序字段</span>
                            <el-select style="margin-top:5px;" v-model="sortrow.attributeName" filterable>
                                <el-option v-for="item in listdata"
                                           :key="item.key"
                                           :label="item.label"
                                           :value="item.key">
                                </el-option>
                            </el-select>
                        </div>

                        <div class="item-right">
                            <span class="shift-name-title">排序方式</span>
                            <div style="padding-top:10px;clear:both;">
                                <el-radio v-model="sortrow.sort" label="ASC">升序</el-radio>
                                <el-radio v-model="sortrow.sort" label="DESC">降序</el-radio>
                                <i class="el-icon-delete" @click="deleterow(index)"></i>
                            </div>
                        </div>
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addrow">
                    <el-button @click="addrow">添加排序字段</el-button>
                </div>
            </div>
            
        </div>
        <div class="popup-foot">
            <div id="Save" class="popup-foot-shur save-checking">确定</div>
            <div class="close">取消</div>
        </div>
    </div>
    <script src="/EXT/ext-3.3.3/ext.js"></script>
    <script src="/jslibrary/sfdc/main_source.js"></script>
    <script src="/jslibrary/jslabels/zh_CN.js"></script>
    <script src="/jslibrary/sfdc/Chatter.js"></script>
    <script src="/js/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/CommonUtils.js"></script>
    <script type="text/javascript" src="/element/vue.js"></script>
    <script type="text/javascript" src="/element/element.js"></script>
    <script type="text/javascript" src="/element/vue-resource.js"></script>
    <script>
        var vum = new Vue({
            el: '#vueapp',
            data: {
                module: [],
                listdata: [],
                sortdata: [{
                    attributeName: '',
                    SortDir: 'ASC',
                }]

            },
            created: function () {
                this.getData()
            },

            methods: {
                deleterow: function (index) {
                    this.sortdata.splice(index, 1)
                },
                addrow: function () {
                    console.log(this.sortdata)
                    this.sortdata.push({
                        attributeName: '',
                        sort: 'ASC',
                    })
                },
                getData: function () {
                    var that = this
                    if (1) {
                        var id = parent.webContext.defaultFilterId
                        var d = { id: id, showAllField: 1 };
                        ajaxMethodGetData('entity.filter.get', d
                            , function (data) {
                                that.module = []
                                that.listdata = []
                                for (var i = 0; i < data.entity.attributes.length; i++) {
                                    that.listdata.push({
                                        key: data.entity.attributes[i].name,
                                        label: data.entity.attributes[i].label + ' ' + data.entity.attributes[i].name,
                                    })
                                }
                                var ColumnSet = data.filter[0].ColumnSet.split(',')
                                for (var i = 0; i < ColumnSet.length; i++) {
                                    for (var j = 0; j < that.listdata.length; j++) {
                                        if (ColumnSet[i] == that.listdata[j].key) {
                                            that.module.push(ColumnSet[i])
                                        }
                                    }
                                }

                                if (data.filter[0].orderExpression == '') {
                                    data.filter[0].orderExpression = []
                                }
                                if (data.filter[0].OrderExpression && data.filter[0].OrderExpression != null) {
                                    that.sortdata = JSON.parse(data.filter[0].OrderExpression)
                                }
                                //if (data.filter[0].SortField) {
                                //    that.SortField = data.filter[0].SortField

                                //}
                                //if (data.filter[0].SortDir) {
                                //    that.SortDir = data.filter[0].SortDir

                                //}
                            })
                    }
                },
                
            }
        })
    </script>
    <script src="/js/alert.js"></script>
    <script>window.editPage_DLBEInstance = new DuelingListBoxesElement(['duel_select_0', 'duel_select_1'], 'editPage_duel_errorMsg');</script>

    <script>

        $('#b1').click(function () {
            $obj = $('.due_select option:selected').clone(true);
            $objc = $('.due_select option:selected').clone(true);
            if ($obj.size() == 0) {
                //alert("璇疯嚦灏戦€夋嫨涓€鏉�!");
            }
            $('#duel_select_1').append($obj);
            //$('#checkselect').append($objc);
            $('.due_select option:selected').remove();
        });

        //$('#b2').click(function () {
        //    $('#s2').append($('#s1 option'));
        //});
        $('#duel_select_1').change(function(){
            console.log($('#duel_select_1').val())
        });

        $('#b3').click(function () {
            $obj = $('.due_select option:selected').clone(true);
            $objc = $('.due_select option:selected').clone(true);
            if ($obj.size() == 0) {
                //alert("璇疯嚦灏戦€夋嫨涓€鏉�!");
            }
            $('#duel_select_0').append($obj);
            //var d1 = $('#duel_select_1').val()
            //for (var i = 0; i < d1.length; i++) {
            //    $('#checkselect option[value="' + d1[i] + '"]').remove();
            //}
            $('.due_select option:selected').remove();
        });

        //$('#b4').click(function () {
        //    $('#s1').append($('#s2 option'));
        //});


        $('#closeds').click(function () {
            window.parent.document.getElementById("changeDiv").style.display = "none";
        })
        $('#closedsa').click(function () {
            window.parent.document.getElementById("changeDiv").style.display = "none";
        })
    </script>
    <script>
        $('.close').click(function () {
            parent.$('.popup-mask').hide()
            parent.$('#iframe').hide()
            parent.$('#changeDiv').hide()
        })
        var objectTypeCode = parent.webContext.objectTypeCode
        var id = parent.webContext.defaultFilterId
        //console.log(objectTypeCode)
        //console.log(id)
        var d = { id: id,showAllField:1 };
        ajaxMethodPostData('entity.filter.get', d, renderOptions);
        function renderOptions(data)
        {
            
            $('input[value="' + data.filter[0].SortDir + '"]').attr('checked','checked')
            var selectFields  =null;
            if(data.filter)
            {
                if(data.filter.length>0)
                {
                    var filter =  data.filter[0];
                    var cs = filter.ColumnSet;
                    if (cs != "") {
                        selectFields = cs.split(",");
                    }

                }
                //console.log(selectFields);
            }
            //console.log(data)
            $('#duel_select_0').find('option').remove();
            $('#duel_select_1').find('option').remove();
            var datas = data.entity.attributes
            //console.log(datas)
            var isSelected = isSelectedField(selectFields,datas);

            var datas2 = data.filter[0].ColumnSet
            datas2 = datas2.split(',')
            // console.log(datas2)

            for (var i = 0; i < datas2.length; i++) {
                var res = datas2[i]
                var name = res
                var label = ''
                for (var j = 0; j < $('#duel_select_1 option').length; j++) {
                    if (name == $('#duel_select_1 option').eq(i).attr('value')) {
                        $('#duel_select_1').append($('#s1 option').eq(i))
                    }
                }

            }
            $('option').dblclick(function () {
                var flag = $(this).parent().attr('id');
                if (flag == "duel_select_0") {
                    var $obj = $(this).clone(true);
                    $('#duel_select_1').append($obj);
                    $(this).remove();
                } else {
                    var $obj = $(this).clone(true);
                    $('#duel_select_0').append($obj);
                    $(this).remove();
                }
            });
            $('#checkselect').val(data.filter[0].SortField)
        }

        function isSelectedField(selectFields, datas) {
            
            if (selectFields) {
                $('#checkselect').html('')
                for (var r = 0; r < selectFields.length; r++) {
                    var selField = selectFields[r];
                    for (var i = 0; i < datas.length; i++) {
                        var res = datas[i];
                        var label = res.label;
                        var name = res.name;
                        if (selField == name) {
                            $('#duel_select_1').append('<option value="' + name + '">' + label + '</option>');
                            //$('#checkselect').append('<option value="' + name + '">' + label + '</option>');
                            $('#duel_select_0').find('option[value="' + name + '"]').remove()
                        }
                        else if (r == 0) {
                            $('#duel_select_0').append('<option value="' + name + '">' + label + '</option>');
                        }
                        $('#checkselect').append('<option value="' + name + '">' + label + '</option>');
                    }

                }
            } else {
                for (var i = 0; i < datas.length; i++) {
                    var res = datas[i];
                    var label = res.label;
                    var name = res.name;
                    $('#duel_select_0').append('<option value="' + name + '">' + label + '</option>');
                    $('#checkselect').append('<option value="' + name + '">' + label + '</option>');
                }
            }

        }

        $('#Save').click(function(){
            var displayCols = ''
            $('#duel_select_1 option').each(function(){
                if(displayCols==''){
                    displayCols = $(this).val()
                }else{
                    displayCols+=","+$(this).val()
                }
            })
            //var SortField = $('.checkselect').val()
            //var SortDir = $('input[name="SortDir"]:checked').val()
            var orderExpression = vum.sortdata
            orderExpression = JSON.stringify(orderExpression)
            var d = {
                id: parent.webContext.defaultFilterId,
                filterId: parent.webContext.defaultFilterId,
                displayCols: displayCols,
                //SortField: SortField,
                //SortDir: SortDir,
                orderExpression: orderExpression
            }
            function renderOptions(data){
                //console.log(data)
                parent.$('#iframe').hide();
                parent.$('.popup-mask').hide();
                parent.$('#changeDiv').hide();
                parent.success('字段选择成功')
                parent.GridInstance.swithFilter(parent.webContext.defaultFilterId);
            }
            ajaxMethodPostData('entity.filter.column.save', d, renderOptions);
        })


    </script>
</body>
</html>
