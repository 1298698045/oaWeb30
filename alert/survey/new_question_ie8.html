<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body, html {
            width: 100%;
        }

        .popup-exit {
            width: 20px;
            height: 20px;
            position: absolute;
            right: 15px;
            top: 15px;
            background: url('/img/cal/closegray.png') no-repeat center;
            background-size: 18px;
            cursor: pointer;
        }

        .popup-head {
            color: #333;
            height: 58px;
            line-height: 60px;
            font-size: 16px;
            text-align: center;
            border-bottom: 2px solid #dcdcdc;
        }

        #popup-zhuangtaichange .popup-body {
            padding: 20px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .popup-foot > div {
            width: 65px;
        }

        .popup-foot > div {
            float: right;
            background-color: white;
            border: 1px solid #dcdcdc;
            color: #108af9;
            height: 32px;
            border-radius: 4px;
            text-align: center;
            line-height: 32px;
            margin-right: 10px;
            cursor: pointer;
            margin-top: 10px;
            padding: 0 10px;
        }

        .popup-foot {
            border-radius: 0;
            border-top: 2px solid #dcdcdc;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            padding-bottom: 15px;
            height: 40px;
        }
        .popup-foot .popup-foot-shur {
            color: white;
            background-color: #108af9;
        }
        .red {
            color: red;
            position:absolute;
            left:0;
        }
        .item-left {
            float: left;
            width: 47%;
        }

        .item-right {
            float: right;
            width: 47%;
        }

        .popup-body {
            padding: 20px;
            height: 438px;
            overflow: auto;
        }

        .item-body {
            margin-top: 5px;
            position:relative;
        }

        input {
            height: 32px;
            line-height: 32px;
            border-radius: 4px;
        }

        textarea {
            height: 50px;
        }

        input, textarea {
            width: 100%;
            border: 1px solid #dedede;
        }

        .item {
            margin-top: 10px;
        }

        .popup-foot .popup-foot-shur:hover {
            color: white;
            background-color: #0d7ade !important;
        }

        .disstatus {
            border-color: red;
        }

        .save-status {
            font-size: 12px;
            color: red;
        }

        .form-error {
            margin-top: 10px;
            text-align: left;
            width: 100%;
            background: rgb(194, 57, 52);
            padding: 15px;
            color: #fff;
            border-radius: 4px;
            height: 50px;
            box-sizing: border-box;
        }
        .form-error2 {
            color: rgb(194, 57, 52);
            margin-left: 15px;
            margin-top: 10px;
            font-size: 14px;
            text-align: left;
        }
        .item-title {
            display: inline-block;
            margin-bottom: 5px;
            padding-left:10px;
            float:left;
            width:85px;
            line-height:38px;
        }
        .section-title {
            padding: 5px;
            background-color: #f2f2f2;
            border-radius: 4px;
        }
        input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }
        .red {
            float:left;
            line-height:38px;
            color: red;
        }
        .popup-body .layui-input-block {
            margin-left: 100px;
        }
        .section-body {
            padding: 0 20px;
        }
        .section {
            padding-bottom: 20px;
        }
        .layui-form input {
            text-indent: 5px !important;
        }
        .editimg {
            cursor:pointer;
            margin-left:10px;
            width:18px;
            height:18px;
        }
        th {
            text-align:left;
            text-indent:5px;
            color:#333;
            font-weight:400;
        }
         th.question-grade {
            display:none;
        }
        tr {
            height:45px;
        }
        .popup,html,body{
            overflow:hidden;
        }
        .question-isDefault {
            text-align:center;
        }
        .layui-unselect.layui-form-radio {
            margin-left:20px;
        }
    </style>
</head>
<body>
    <div class="popup" style="display: block;">
        <div class="popup-exit close"></div>
        <div class="popup-head">
            新建问题
        </div>
        <div class="popup-body layui-form">
            <div class="modal-header"></div>

            <div class="section">
                <div class="section-title">基本信息</div>
                <div class="section-body">
                    <div class="item divs">
                        <div class="item-left">
                            <div class="item-body">
                                <span class="red">*</span>
                                <span class="item-title">问题类型</span>
                                <div class="layui-input-block">
                                    <select onchange="QuestionTypechange(val)" lay-verify="" id="QuestionType">
                                        <option value="1">单选</option>
                                        <option value="2">多选</option>
                                        <option value="5">单行文本</option>
                                        <option value="52">多行文本</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-body">
                                <span class="item-title">此题必答</span>
                                <div class="layui-input-block">
                                    <input id="Required" type="checkbox" name="switch" lay-skin="switch">
                                </div>
                            </div>
                        </div>
                        <div style="clear:both;"></div>
                    </div>
                   
                    <div class="item divs">
                        <div class="" >
                            <div class="item-body">
                                <span class="red">*</span>
                                <span class="item-title">问题</span>
                                <div class="layui-input-block">
                                    <textarea id="Question" name="desc" placeholder="请输入内容" class="layui-textarea save-checking-input"></textarea>
                                </div>
                            </div>
                        </div>
                        <div style="clear:both;"></div>
                    </div>
                    <div class="item divs">
                        <div class="item-left">
                            <div class="item-body">
                                <span class="item-title">分组一</span>
                                <div class="layui-input-block">
                                    <input id="QuestionGroup" type="text" name="title" placeholder="" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-body">
                                <span class="item-title">序号</span>
                                <div class="layui-input-block">
                                    <input type="text" id="SortNumber" name="title" placeholder="" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div style="clear:both;"></div>
                    </div>
                    <div class="item divs">
                        <div class="item-left">
                            <div class="item-body">
                                <span class="item-title">分组二</span>
                                <div class="layui-input-block">
                                    <input id="SubCategory"  type="text" name="title" placeholder="" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="item-right">
                            <div class="item-body" style="float:left;">
                                <span class="item-title">问题分组</span>
                                <div class="layui-input-block">
                                    <input checked="checked" id="question-group" type="checkbox" name="switch" lay-skin="switch">
                                </div>
                            </div>
                            <div class="item-body" style="float:left;margin-left:20px;">
                                <span class="item-title">问题分值</span>
                                <div class="layui-input-block">
                                    <input id="question-grade" type="checkbox" name="switch" lay-skin="switch">
                                </div>
                            </div>
                        </div>
                        <div style="clear:both;"></div>
                    </div>
                    <div class="item divs">
                        <table style="width:100%;">
                            <tr style="height:35px;">
                                <th class="" style="width:90px;padding-left:10px;"></th>
                                <th style="">选项</th>
                                <th style="text-align:center;">默认</th>
                                <th style="padding-left:10px;" class="question-group">分组</th>
                                <th style="padding-left:10px;" class="question-grade">分值</th>
                                <th></th>
                            </tr>
                            <tr>
                                <td class="" style="width:90px;padding-left:10px;">选项1</td>
                                <td class="question-title">
                                    <input type="text" name="title" placeholder="" autocomplete="off" class="layui-input">
                                </td>
                                <td class="question-isDefault">
                                    <input type="radio" name="IsDefault" lay-skin="primary">
                                </td>
                                <td class="rowedit">
                                    <img class="editimg" onclick="rowdelete(this)" src="/img/images/02.1.2.1.Subtract_.png" alt="" /><img class="editimg" onclick="rowadd(this)" src="/img/images/02.1.2.1.Add_.png" alt="" />
                                </td>
                            </tr>
                            <tr>
                                <td class="" style="width:90px;padding-left:10px;">选项2</td>
                                <td class="question-title">
                                    <input type="text" name="title" placeholder="" autocomplete="off" class="layui-input">
                                </td>
                                <td class="question-isDefault">
                                    <input type="radio" name="IsDefault" lay-skin="primary">
                                </td>
                                <td class="rowedit">
                                    <img class="editimg" onclick="rowdelete(this)" src="/img/images/02.1.2.1.Subtract_.png" alt="" /><img class="editimg" onclick="rowadd(this)" src="/img/images/02.1.2.1.Add_.png" alt="" />
                                </td>
                            </tr>
                        </table>
                         
                    </div>
                 </div>
            </div>
        </div>
        <div class="popup-foot">
            <div class="popup-foot-shur save-checking">确定</div>
            <div class="close">取消</div>
        </div>
    </div>
    <script src="/js/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/CommonUtils.js"></script>
    <script src="/js/laydate/laydate.js"></script>
    <script src="/layui/layui/layui.js"></script>
    <link href="/layui/layui/css/layui.css" rel="stylesheet" />
    <script src="/js/alert.js"></script>
    <script>

        var form = ''
        layui.use(['form'], function () {
            form = layui.form
            $('#question-group').next().click(function () {
                questiongroup()
            })
            $('#question-grade').next().click(function () {
                questiongrade()
            })
            $('#QuestionType').next().find('dd').click(function(){
                if ($(this).attr('lay-value') == '5' || $(this).attr('lay-value') == '52') {
                    $('table tbody tr').not($('table tbody tr:first')).remove()
                    $('table tbody tr:first').hide()
                } else if ($('table tbody tr').length == 1) {
                    $('table tbody tr:first').show()
                    rowadd()
                    rowadd()
                }
            })
            getdata()
            questiongroup()
            
        });
        function questiongroup() {
            if ($('#question-group').next().hasClass('layui-form-onswitch')) {
                $('th.question-group').show()
                $('.question-title').each(function () {
                    if ($(this).next().next('.question-group').length == 0) {
                        $(this).next().after('<td class="question-group" style="padding-left:10px;">'
                                    + '<input type="text" name="title" placeholder="" autocomplete="off" class="layui-input">'
                                + '</td>')
                    }
                })
            } else {
                $('th.question-group').hide()
                $('td.question-group').remove()
            }
        }
        function questiongrade() {
            if ($('#question-grade').next().hasClass('layui-form-onswitch')) {
                $('th.question-grade').show()
                $('.rowedit').each(function () {
                    if ($(this).prev('.question-grade').length == 0) {
                        $(this).before('<td class="question-grade" style="padding-left:10px;">'
                                    + '<input type="number" name="title" placeholder="" autocomplete="off" class="layui-input">'
                                + '</td>')
                    }
                })
            } else {
                $('th.question-grade').hide()
                $('td.question-grade').remove()
            }
        }
        
        function rowdelete(dom) {
            if ($('tr').length > 2) {
                $(dom).parents('tr').remove()
            }
        }
        function rowadd() {
            $('table tbody').append('<tr>'
                            + '<td class="" style="width:90px;padding-left:10px;">选项' + $('table tr').length + '</td>'
                            +    '<td class="question-title">'
                            +        '<input type="text" name="title" placeholder="" autocomplete="off" class="layui-input">'
                            + '</td>'
                            +'<td class="question-isDefault">'
                            + '        <input type="radio" name="IsDefault" lay-skin="primary">'
                            +'</td>'
                            +    '<td class="rowedit">'
                            +        '<img class="editimg" onclick="rowdelete(this)" src="/img/images/02.1.2.1.Subtract_.png" alt="">'
                            +        '<img class="editimg" onclick="rowadd(this)" src="/img/images/02.1.2.1.Add_.png" alt="">'
                            +    '</td>'
                            + '</tr>')
            questiongroup()
            questiongrade()
            form.render('radio')
        }

        $('.close').click(function () {
            parent.$('.popup-mask').hide()
            parent.$('#iframe').hide()
        })
        $('.save-checking').click(function () {
            
            var Required = ''
            if ($('#Required').attr('checked') == 'checked') {
                Required = true
            } else {
                Required = false
            }
            var EnableCore = ''
            if ($('#question-grade').next().hasClass('layui-form-onswitch')) {
                EnableCore = true
            } else {
                EnableCore = false
            }
            var Options = []
            for (var i = 1; i < $('tr').length; i++) {
                var item = {
                    AnswerOption: $('tr').eq(i).find('.question-title input').val()
                }
                if ($('#question-grade').next().hasClass('layui-form-onswitch')) {
                    item.Points = $('tr').eq(i).find('.question-grade input').val()
                }
                if ($('#question-group').next().hasClass('layui-form-onswitch')) {
                    item.AnswerOptionGroup = $('tr').eq(i).find('.question-group input').val()
                }
                if ($('tr').eq(i).attr('QuestionAnswerOptionId')) {
                    item.QuestionAnswerOptionId = $('tr').eq(i).attr('QuestionAnswerOptionId')
                }
                var IsDefault = false
                if ($('tr').eq(i).find('.layui-form-radioed').length > 0) {
                    IsDefault = true
                }
                item.IsDefault = IsDefault
                Options.push(item)
            }
            var message = {
                SurveyId: parent.getQueryString('id'),
                Question: $('#Question').val(),
                QuestionGroup: $('#QuestionGroup').val(),
                SubCategory: $('#SubCategory').val(),
                SortNumber: $('#SortNumber').val(),
                SortNumber: $('#SortNumber').val(),
                QuestionType: $('#QuestionType').val(),
                Required: Required,
                EnableCore:EnableCore,
                Options: Options,
            }
            var id = getQueryString('id')
            if (id) {
                message.SurveyQuestionId = id
            }
            message = JSON.stringify(message)
            var data = {
                message: message
            }
            ajaxMethodPostData('survey.question.edit', data, function (data) {
                parent.success('保存问题成功')
                parent.$('#changeDiv').hide()
                parent.getdata()
            })
        })

        
        function getdata() {
            var id = getQueryString('id')
            if (id) {
                $('.popup-head').html('编辑问题')
                var d = {
                    id: id,
                }
                ajaxMethodPostData('survey.question.get', d, function (data) {
                    var res = data.listData
                    $('#Question').val(res.Question)
                    $('#QuestionGroup').val(res.QuestionGroup)
                    $('#SubCategory').val(res.SubCategory)
                    $('#SortNumber').val(res.SortNumber)
                    $('#SortNumber').val(res.SortNumber)
                    $('#QuestionType').val(res.QuestionType)
                    var EnableScore = res.EnableScore
                    if (EnableScore) {
                        $('#question-grade').prop('checked', 'checked')
                        $('#question-grade').next().addClass('layui-form-onswitch')
                    }
                    if (res.Required) {
                        $('#Required').next().addClass('layui-form-onswitch')
                    }
                    if (res.EnableCore) {
                        $('#question-grade').next().addClass('layui-form-onswitch')
                    }
                    $('table tbody tr').not($('tr:first')).remove()
                    $('tr:first').hide()
                    for (var i = 0; i < res.Options.length; i++) {
                        rowadd()
                        if (res.Options[i].IsDefault == true) {
                            $('.question-isDefault:last').find('input').prop('checked', 'checked')
                            $('.question-isDefault:last .layui-form-radio').addClass('layui-form-radioed')
                        }
                        $('.question-title:last').find('input').val(res.Options[i].Name)
                        $('.question-grade:last').find('input').val(res.Options[i].Points)
                        $('.question-group:last').find('input').val(res.Options[i].AnswerOptionGroup)
                        $('tr:last').attr('QuestionAnswerOptionId', res.Options[i].QuestionAnswerOptionId)
                        $('tr:first').show()
                    }
                    questiongroup()
                    questiongrade()
                })
            }
            
        }

    </script>
</body>
</html>
