<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link rel="stylesheet" href="/css/themes/lightning/iconfont.css" />
    <link rel="stylesheet" href="/css/themes/lightning/alerts.css" />
    <link href="/template/css/alert.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body,
        html {
            width: 100%;
        }

        .popup-exit {
            width: 20px;
            height: 20px;
            position: absolute;
            right: 15px;
            top: 15px;
            background: url("/img/cal/closegray.png") no-repeat center;
            background-size: 18px;
            cursor: pointer;
        }

        .popup-head {
            color: #333;
            height: 58px;
            line-height: 60px;
            font-size: 16px;
            text-align: center;
            border-bottom: 1px solid #dcdcdc;
        }

        #popup-zhuangtaichange .popup-body {
            padding: 10px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .popup-foot > div {
            width: 65px;
        }

        .popup-foot > div {
            float: right;
            background-color: white;
            border: 1px solid #dcdcdc;
            color: #108af9;
            height: 32px;
            border-radius: 4px;
            text-align: center;
            line-height: 32px;
            margin-right: 10px;
            cursor: pointer;
            margin-top: 10px;
            padding: 0 10px;
        }

        .popup-foot {
            border-radius: 0;
            border-top: 1px solid #dcdcdc;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            padding-bottom: 15px;
            height: 40px;
        }

        .popup-foot .popup-foot-shur {
            color: white;
            background-color: #108af9;
        }

        .red {
            color: red;
        }
        .popup-body {
            padding: 10px;
            height: 338px;
            overflow: hidden;
        }
        .item-body {
            margin-top: 5px;
        }

        input {
            height: 32px;
            line-height: 32px;
            border-radius: 4px;
        }

        textarea {
            height: 50px;
        }

        input,
        textarea {
            width: 100%;
            border: 1px solid #dedede;
        }

        .item {
            margin-top: 10px;
        }

        .popup-foot .popup-foot-shur:hover {
            color: white;
            background-color: #0d7ade !important;
        }

        .disstatus {
            border-color: red;
        }

        .save-status {
            font-size: 12px;
            color: red;
        }

        .form-error {
            margin-top: 10px;
            text-align: left;
            width: 100%;
            background: rgb(194, 57, 52);
            padding: 15px;
            color: #fff;
            border-radius: 4px;
            height: 50px;
            box-sizing: border-box;
        }

        .form-error2 {
            color: rgb(194, 57, 52);
            margin-left: 15px;
            margin-top: 10px;
            font-size: 14px;
            text-align: left;
        }

        .item-title {
            display: inline-block;
            margin-bottom: 5px;
        }

        .section-title {
            padding: 5px;
            background-color: #f2f2f2;
            border-radius: 4px;
        }

        input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        .popup-body .layui-input-block {
            margin-left: 0;
        }

        .section-body {
            padding: 0 20px;
        }

        .section {
            padding-bottom: 20px;
        }

        .red {
            color: red;
        }

        .layui-form input {
            text-indent: 5px !important;
        }

        .popup-exit {
            width: 20px;
            height: 20px;
            position: absolute;
            right: 15px;
            top: 15px;
            background: url("/img/cal/closegray.png") no-repeat center;
            background-size: 18px;
            cursor: pointer;
        }

        .item-body {
            width: 400px;
        }

        .centerdiv > div {
            float: left;
             width:100%;
        }
        .center {
            width: 100px;
            text-align: center;
            position: relative;
            height: 100%;
        }

        ul,
        li {
            list-style: none;
        }

        #deptsearchkey {
            width: 353px;
        }

        .adddept {
            position: absolute;
            top: 40%;
            cursor: pointer;
            color: #108def;
            margin-left: -15px;
        }

        .centerdiv {
            display: inline-block;
            height: 100%;
            width:100%;
        }

        .popup-body {
            text-align: center;
        }
        .datagrid-body .datagrid-editable{
            padding:0 4px !important;
        }
        .panel-htop{
            border-right:1px solid #D4D4D4 !important;
        }
        .combo-p.panel-htop{
            border-right:0 !important;
        }
        .partsearch{
            background: url(/img/images/02.1-1.Search_.png) no-repeat center center !important;
            background-size: 15px !important;
        }
    </style>
</head>
<body>
    <div class="popup" style="display: block">
        <div class="popup-head">批量录入兼职</div>
        <div class="popup-body layui-form">
            <div class="centerdiv">
                <table id="dg" title=""></table>
            </div>

            <div style="clear: both; float: none"></div>
        </div>
        <div class="popup-foot">
            <div id="Save" class="popup-foot-shur">保存</div>
            <div class="close">取消</div>
        </div>
    </div>
    <!--<iframe frameborder="0" src="" id="iframe"></iframe>
    <div class="popup-mask"></div>-->

    <script src="/js/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/CommonUtils.js"></script>
    <script src="/js/alert.js"></script>
    <link rel="stylesheet" href="/easyui/themes/bootstrap/easyui.css" type="text/css" />
    <link rel="stylesheet" href="/easyui/themes/icon.css" type="text/css" />
    <script type="text/javascript" src="/easyui/js/treeLoader.js"></script>
    <script type="text/javascript" src="/easyui/js/GridEasy.js"></script>
    <script type="text/javascript" src="/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/easyui/locale/easyui-lang-zh_CN.js"></script>
    
    <script>
        var OwningBusinessUnitdata = [];
        var that = this;
        ajaxMethodGetData("tree.get&entity=organizationtree", {},
              function (data) {
                  that.OwningBusinessUnitdata = data.rows;
              }
            );
        //fetch('/apps/CommandProcessor.ashx?c=1&cmd=tree.get&entity=organizationtree').then(res => {
        //    return res.json();
        //}).then(data => {
        //    var dataz = data.rows;
        //    //that.OwningBusinessUnitdata = dataz.slice(0, 100);
        //    that.OwningBusinessUnitdata = dataz
        //})
      var $dg = $("#dg");
        $dg.datagrid({
          url: "/apps/CommandProcessor.ashx?c=1&cmd=entity.grid.search",
          queryParams: {
            entityType: "SystemUserBusinessUnits",
            filterQuery: "\nSystemUserId\teq\t" + getQueryString("id"),
          },
          fitColumns: true,
          width:document.body.clientWidth*0.98,
          height: 330,
          rownumbers: true,
          singleSelect:true,
          pagination: false,
          loadFilter: function (data) {
              if(data){
                  if (data.rows) {
                      if (data.rows.Table) {
                          data.rows = data.rows.Table;
                      }
                  }
              }
              else {
                  data = {
                      rows: [],
                      total:0
                  }
              }
              return data
          },
          onLoadSuccess: function () {
              $(".datagrid-header-check").html("");
          },
          columns: [
            [
              { field: 'SystemUserBusinessUnitId', title: 'id', width: 20, align: 'center', checkbox: true },
              {
                field: "BusinessUnitId",
                title: "兼职部门",
                width: 200,
                align: "center",
                formatter: function (value, row, index) {
                    if (that.OwningBusinessUnitdata == undefined)
                        return "";
                    for (var i = 0; i < that.OwningBusinessUnitdata.length; i++) {
                        var a = that.OwningBusinessUnitdata[i]
                        if (a.id == value) {
                            return  a.text;
                        }
                    }
                },
                editor:{
                    type:'combobox',
                    options:{
                        valueField: 'id',
                        textField: 'text',
                        required: 'true',
                        data: that.OwningBusinessUnitdata,
                        editable: true,
                        mode: 'local',
                        loadFilter: function (data) {
                            if(data){
                                var row = $dg.datagrid("getSelected");
                                if (row && that.OwningBusinessUnitdata != undefined) {
                                    var obudata = JSON.stringify(that.OwningBusinessUnitdata)
                                    if (obudata.indexOf(row.BusinessUnitId) == -1) {
                                        that.OwningBusinessUnitdata.push({ id: row.BusinessUnitId, text: row.BusinessUnitTitle })
                                    }
                                    return that.OwningBusinessUnitdata;
                                }
                            }
                        },
                        filter: function (q, row) {
                            var opts = $(this).combobox('options');
                            return row[opts.textField].indexOf(q) > -1;
                        },
                        formatter: function (row) {
                            var opts = $(this).combobox('options');
                            return row[opts.textField];
                        },
                        onSelect: function (option) {
                            var row = $dg.datagrid("getSelected");
                            if (row) {
                                row.BusinessUnitId = option.id;
                                row.BusinessUnitTitle = option.text
                            }
                        },
                        onBeforeLoad: function (param) {
                            var that = this
                            $(that).combobox('textbox').focus(function () {
                                //$('.combo-panel').show()
                                //$(that).next().find('a').click()
                                //$('.textbox-focused span a').click()
                            });
                            setTimeout(function () {
                                $(that).next().find('a').click()
                                $(that).next().find('a').addClass('partsearch')
                                $(that).next().find('.textbox-addon-right').addClass('textboxsearch')
                                $(".textboxsearch").css("cursor", "pointer");
                                $(".textboxsearch").click(function () {
                                    $('.combo-p').hide()
                                    $('.combo-panel').hide()
                                    $(this).next().next().attr('name', 'BusinessUnitId')
                                    var name = "BusinessUnitId"
                                    opencenterwindow('/alert/deptchose_form.html?type=relatedchhoose&lknm=' + name, '', 750, 520)
                                });
                            }, 100)
                        },
                        onLoadSuccess: function () {
                            var that = this
                        },
                    },
                },
              },
              {
                field: "TitleStart",
                title: "开始时间",
                width: 200,
                align: "center",
                formatter: function (value, row, index) {
                    if (value == null || value == '') {
                        return '';
                    }
                    else {
                        return value.replace(/\s[\x00-\xff]*/g, '');
                    }
                },
                editor: {
                    type: 'datebox',
                    options: {
                        dateFmt: 'yyyy-MM-dd'
                    }
                }
              },
              {
                field: "TitleEnd",
                title: "结束时间",
                width: 200,
                align: "center",
                formatter: function (value, row, index) {
                    if (value == null || value == '') {
                        return '';
                    }
                    else {
                        return value.replace(/\s[\x00-\xff]*/g, '');
                    }
                },
                editor: {
                    type: 'datebox',
                    options: {
                        dateFmt: 'yyyy-MM-dd'
                    }
                }
              },
               {
                   field: "JobTitle",
                   title: "职务",
                   width: 200,
                   align: "center",
                   editor: {
                       type: 'validatebox',
                       options: {
                           required: 'true',
                       }
                   }
               },
            ],
          ],
          onClickRow: function (index, row) {
              //单击编辑
              endEdit();
              $(this).datagrid('beginEdit', index);
          },
          onAfterEdit: function (index, row) {
              row.editing = false;
          },
          toolbar: [
            {
              text: "添加",
              iconCls: "icon-add",
              handler: function () {
                  $dg.datagrid("appendRow", {
                      BusinessUnitId: '',
                      JobTitle: '',
                      TitleStart: '',
                      TitleEnd: ''
                  });
                //endEdit();
                //var rows = $dg.datagrid("getRows");
                //if (rows) {
                //    if(rows.length && rows.length > 0){
                //        var rowIndex = rows.length - 1;
                //        $dg.datagrid("beginEdit", rowIndex);
                //    }
                //}
              },
            },
            {
              text: "编辑",
              iconCls: "icon-edit",
              handler: function () {
                var row = $dg.datagrid("getSelected");
                if (row) {
                  var rowIndex = $dg.datagrid("getRowIndex", row);
                  $dg.datagrid("beginEdit", rowIndex);
                }
                else {
                    $.messager.alert("提示", "请选择要编辑的行");
                }
              },
            },
            {
              text: "删除",
              iconCls: "icon-remove",
              handler: function () {
                  var row = $dg.datagrid("getSelected");
                  if (row) {
                      $.messager.confirm('确认', '确认删除吗?', function (data) {
                          if (data) {
                              var rowIndex = $dg.datagrid("getRowIndex", row);
                              $dg.datagrid("deleteRow", rowIndex);
                              if (row.SystemUserBusinessUnitId) {
                                  var d = {
                                      id: row.SystemUserBusinessUnitId
                                  }
                                  d.objTypeCode = 81
                                  ajaxMethodPostData('entity.delete', d, function (data) {
                                      if (data) {
                                          console.log('删除', data)
                                      }
                                  })
                              }
                              $.messager.alert("提示", "删除成功");
                          } else {
                              //do 取消    	
                          }
                  })
                  }
                  else {
                      $.messager.alert("提示", "请选择要删除的行");
                  }
              },
            },
            {
              text: "取消编辑",
              iconCls: "icon-redo",
              handler: function () {
                endEdit();
                var rows = $dg.datagrid("getRows");
                if (rows) {
                    for (var i = 0; i < rows.length; i++) {
                        if (!rows[i].BusinessUnitId) {
                            $.messager.alert("提示", "请将兼职部门列或职务列必填项填写完整");
                            return
                        }
                        if (!rows[i].JobTitle) {
                            $.messager.alert("提示", "请将职务列填写完整");
                            return
                        }
                    }
                }
              },
            },
            //{
            //  text: "保存",
            //  iconCls: "icon-save",
            //  handler: function () {
            //    endEdit();
            //    var row = $dg.datagrid("getSelected");
            //    if (row) {
            //        if (!row.BusinessUnitId) {
            //            $.messager.alert("提示", "请选择兼职部门");
            //            return
            //        }
            //        if (!row.JobTitle) {
            //            $.messager.alert("提示", "请填写职务");
            //            return
            //        }
            //        function callback(data) {
            //            console.log('保存',data)
            //            if (data) {
            //                $.messager.alert("提示", '保存成功')
            //            }
            //            else {
            //                $.messager.alert("提示", '保存失败')
            //            }
            //        }
            //        var d = {
            //            SystemUserId: { Id: getQueryString("id") },
            //            BusinessUnitId: { Id: row.BusinessUnitId },
            //            JobTitle: row.JobTitle,
            //            TitleStart: row.TitleStart,
            //            TitleEnd: row.TitleEnd
            //        }
                    
            //        var messages = {
            //            params: {
            //                recordRep: {
            //                    objTypeCode: 20496,
            //                    fields: d
            //                }
            //            }
            //        }
            //        if (row.SystemUserBusinessUnitId) {
            //            messages.params.recordRep.id = row.SystemUserBusinessUnitId
            //        }
            //        messages = JSON.stringify(messages)
            //        var data0 = { message: messages };
            //        ajaxMethodPostData('entity.saverecord', data0, callback)
            //    }
            //    else {
            //          $.messager.alert("提示", "请选择要保存的行");
            //    }
               
            //    }
            //},
          ],
        });
       
        function endEdit() {
            var rows = $dg.datagrid("getRows");
            if(rows) {
                for (var i = 0; i < rows.length; i++) {
                    $dg.datagrid("endEdit", i);
                }
            }
        }
        //function choosedept(id) {
        //    var d = parent.getQueryString("id")
        //    $('.popup-mask').show();
        //    $('#iframe').attr('src', '/alert/user/parttimeBusUnit.html?&id=' + id).height(480).css('margin-top', '-250px');
        //    $('#iframe').show();
        //}
        $("#Save").click(function () {
            endEdit();
            var rows = $dg.datagrid("getRows");
            if(rows) {
                for (var i = 0; i < rows.length; i++) {
                    if (!rows[i].BusinessUnitId) {
                        $.messager.alert("提示", "请将兼职部门列或职务列必填项填写完整");
                        return
                    }
                    if (!rows[i].JobTitle) {
                        $.messager.alert("提示", "请将职务列填写完整");
                        return
                    }
                    else if (i == rows.length - 1) {
                        for (var j = 0; j < rows.length; j++) {
                            function callback(data) {
                                if (data) {
                                    $.messager.alert("提示", '保存成功')
                                    setTimeout(function () {
                                        parent.$("#iframe").hide();
                                        parent.$(".popup-mask").hide();
                                        parent.$("#datagrid").datagrid("reload");
                                    },1000)
                                }
                                else {
                                    $.messager.alert("提示", '保存失败')
                                }
                            }
                            var d = {
                                SystemUserId: { Id: getQueryString("id") },
                                BusinessUnitId: { Id: rows[j].BusinessUnitId },
                                JobTitle: rows[j].JobTitle,
                                TitleStart: rows[j].TitleStart,
                                TitleEnd: rows[j].TitleEnd
                            }

                            var messages = {
                                params: {
                                    recordRep: {
                                        objTypeCode: 81,
                                        fields: d
                                    }
                                }
                            }
                            if (rows[j].SystemUserBusinessUnitId) {
                                messages.params.recordRep.id = rows[j].SystemUserBusinessUnitId
                            }
                            messages = JSON.stringify(messages)
                            var data0 = { message: messages };
                            ajaxMethodPostData('entity.saverecord', data0, callback)
                        }
                    }
                }
            }
        });
        $(".close").click(function () {
            parent.$("#iframe").hide();
            parent.$(".popup-mask").hide();
        });
        
       
        function lookupPickdept(id, label, name) {
            //$('[name="' + name + '"]').val(id)
            //$('[name="' + name + '"]').prev().val(label)
            //$('[name="' + name + '"]').parent().prev().val(id)
            var i = $('[name="' + name + '"]').parent().parent().parent().parent().parent().parent().parent().parent().attr('datagrid-row-index')
            $dg.datagrid("updateRow", {
                index: Number(i),
                row: {
                    BusinessUnitId: id,
                    BusinessUnitTitle: label
                }
            });
            $('[name="' + name + '"]').attr('name', '')
            $('.combo-p').hide()
            $('.combo-panel').hide()
        }
        function Fmt(value) {
            var date = new Date(value);
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            m = m < 10 ? '0' + m : m;
            var d = date.getDate();
            d = d < 10 ? ('0' + d) : d;
            return  y + '-' +m + '-' + d;
        }
    </script>
</body>
</html>
